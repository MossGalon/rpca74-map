<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìç Map ‡∏£‡∏ß‡∏°‡∏û‡∏• ‡∏£‡∏∏‡πà‡∏ô 74</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #1a1a2e; 
            color: #fff; 
            height: 100vh; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header { 
            background: linear-gradient(135deg, #8B0000, #DC143C); 
            padding: 12px 16px; 
            z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .header h1 { font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .header .count { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 13px; }

        .profile-bar { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 12px; }
        .profile-bar img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        .profile-bar .info { flex: 1; }
        .profile-bar .name { font-size: 14px; font-weight: 600; }
        .profile-bar .status { font-size: 11px; opacity: 0.9; }
        .profile-bar .status.active { color: #4ade80; }
        .profile-bar .status.inactive { color: #fbbf24; }
        .profile-bar .cancel-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }

        #map { 
            flex-grow: 1;
            width: 100%;
            background: #0d0d1a;
        }

        .bottom-actions { 
            background: #1a1a2e; 
            padding: 12px 16px; 
            display: flex; 
            gap: 10px; 
            z-index: 1000; 
            border-top: 1px solid #333;
            padding-bottom: env(safe-area-inset-bottom, 12px);
        }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, #DC143C, #8B0000); color: #fff; }
        .btn-secondary { background: #333; color: #fff; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { background: #333; border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #aaa; }
        .form-group input, .form-group textarea { width: 100%; padding: 14px; border: 1px solid #333; border-radius: 12px; background: #0d0d1a; color: #fff; font-size: 16px; }
        .form-group textarea { resize: none; height: 80px; }
        .form-group small { color: #888; font-size: 12px; margin-top: 4px; display: block; }

        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #DC143C; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; z-index: 2500; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .gps-status { background: #0d0d1a; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 16px; border: 1px solid #333; }
        .gps-status.success { border-color: #22c55e; }
        .gps-status.error { border-color: #ef4444; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <h1>üìç Map ‡∏£‡∏ß‡∏°‡∏û‡∏• ‡∏£‡∏∏‡πà‡∏ô 74</h1>
            <span class="count" id="activeCount">0 ‡∏Ñ‡∏ô</span>
        </div>
        <div class="profile-bar" id="profileBar" style="display:none;">
            <img id="profilePic" src="" alt="Profile">
            <div class="info">
                <div class="name" id="profileName">-</div>
                <div class="status" id="profileStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <button class="cancel-btn" id="cancelBtn" style="display:none;" onclick="cancelCheckin()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </header>

    <div id="map"></div>

    <div class="bottom-actions">
        <button class="btn btn-secondary" onclick="refreshData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn btn-primary" id="checkinBtn" onclick="openCheckinModal()">üìç ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
    </div>

    <div class="modal-overlay" id="checkinModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üìç ‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <button class="modal-close" onclick="closeCheckinModal()">‚úï</button>
            </div>
            <div class="gps-status" id="gpsStatus">
                <span id="gpsIcon">üì°</span>
                <span id="gpsText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...</span>
            </div>
            <form onsubmit="submitCheckin(event)">
                <div class="form-group">
                    <label>üìç ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡∏£‡πâ‡∏≤‡∏ô *</label>
                    <input type="text" id="placeName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πä‡∏Å‡πÄ‡∏°‡πâ‡∏á, ‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required>
                </div>
                <div class="form-group">
                    <label>üí¨ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <textarea id="caption" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏°‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ"></textarea>
                    <small>‚è∞ ‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</small>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡πÄ‡∏Ñ‡∏ä‡∏±‡πà‡∏ô</button>
            </form>
        </div>
    </div>

    <div class="loading-overlay active" id="loadingOverlay"><div class="spinner"></div><span style="margin-top:10px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</span></div>
    <div class="toast" id="toast"></div>

    <script>
        const CONFIG = {
            LIFF_ID: '2008817438-v258p2h9',
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwg4gQ66uNni4cSauLtN9S0uuBVq-Co0ydTcrVB2mU7aJHy4q9EalBtcpX4V9iPLkFG/exec'
        };

        let map, markers = [], userProfile = null, currentLat = null, currentLng = null;
        let ProfileMarkerClass = null;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            if (diffMins < 60) return diffMins + ' ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            if (diffHours < 24) return diffHours + ' ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            return Math.floor(diffHours / 24) + ' ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
        }

        function initMap() {
            console.log('Google Maps Callback Triggered');
            const mapContainer = document.getElementById('map');
            
            map = new google.maps.Map(mapContainer, {
                center: { lat: 13.7563, lng: 100.5018 },
                zoom: 6,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                styles: [{ featureType: "poi.business", stylers: [{ visibility: "off" }] }]
            });

            // Custom Overlay with status and time
            ProfileMarkerClass = class extends google.maps.OverlayView {
                constructor(pos, data, isMe) {
                    super();
                    this.pos = pos;
                    this.data = data;
                    this.isMe = isMe;
                }
                onAdd() {
                    const div = document.createElement('div');
                    div.style.position = 'absolute';
                    div.style.cursor = 'pointer';
                    const color = this.isMe ? '#22c55e' : '#DC143C';
                    const timeAgo = getTimeAgo(this.data.checkinTime);
                    const caption = this.data.caption ? this.data.caption : '';
                    
                    div.innerHTML = `
                        <div style="background:#fff; border:3px solid ${color}; border-radius:12px; padding:6px; min-width:70px; max-width:100px; box-shadow:0 2px 8px rgba(0,0,0,0.4); position:relative;">
                            <img src="${this.data.pictureUrl}" style="width:50px; height:50px; border-radius:8px; display:block; margin:0 auto; object-fit:cover;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(this.data.nickname)}&background=DC143C&color=fff'">
                            <div style="font-size:11px; color:#333; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center; margin-top:4px;">${this.isMe ? '‚≠ê ' : ''}${this.data.nickname}</div>
                            <div style="font-size:9px; color:${color}; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center;">üìç ${this.data.placeName}</div>
                            ${caption ? `<div style="font-size:9px; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center; font-style:italic;">"${caption}"</div>` : ''}
                            <div style="font-size:8px; color:#999; text-align:center; margin-top:2px;">üïê ${timeAgo}</div>
                            <div style="position:absolute; bottom:-10px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-top:10px solid ${color};"></div>
                        </div>
                    `;
                    div.onclick = () => showInfo(this.data, this.pos);
                    this.div = div;
                    this.getPanes().overlayMouseTarget.appendChild(div);
                }
                draw() {
                    const overlayProjection = this.getProjection();
                    const point = overlayProjection.fromLatLngToDivPixel(this.pos);
                    if (this.div) {
                        this.div.style.left = (point.x - 40) + 'px';
                        this.div.style.top = (point.y - 120) + 'px';
                    }
                }
                onRemove() { if (this.div) this.div.parentNode.removeChild(this.div); }
            };

            initLIFF();
        }

        function showInfo(data, pos) {
            const timeAgo = getTimeAgo(data.checkinTime);
            const content = `
                <div style="color:#333; padding:8px; min-width:200px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <img src="${data.pictureUrl}" style="width:45px; height:45px; border-radius:50%; object-fit:cover;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(data.nickname)}&background=DC143C&color=fff'">
                        <div>
                            <strong style="font-size:16px;">${data.nickname}</strong><br>
                            <span style="font-size:12px; color:#999;">üïê ${timeAgo}</span>
                        </div>
                    </div>
                    <div style="color:#DC143C; font-weight:bold; font-size:14px; margin-bottom:4px;">üìç ${data.placeName}</div>
                    ${data.caption ? `<div style="color:#666; font-style:italic; margin-bottom:8px;">"${data.caption}"</div>` : ''}
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}" target="_blank" style="display:block; background:#DC143C; color:#fff; text-align:center; padding:10px; border-radius:8px; text-decoration:none; font-weight:bold;">üöó ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏≤</a>
                </div>
            `;
            const iw = new google.maps.InfoWindow({ content, position: pos });
            iw.open(map);
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                document.getElementById('profileBar').style.display = 'flex';
                document.getElementById('profilePic').src = userProfile.pictureUrl;
                document.getElementById('profileName').textContent = userProfile.displayName;
                
                await refreshData();
            } catch (err) {
                console.error('LIFF Error', err);
                showToast('LIFF Error: ' + err.message);
            }
            showLoading(false);
        }

        async function refreshData() {
            try {
                const res = await fetch(CONFIG.GAS_URL + '?action=getCheckins');
                const data = await res.json();
                if (data.success) {
                    renderMarkers(data.checkins);
                    document.getElementById('activeCount').textContent = data.checkins.length + ' ‡∏Ñ‡∏ô';
                    
                    const myPoint = data.checkins.find(c => c.userId === userProfile.userId);
                    const statusEl = document.getElementById('profileStatus');
                    const cancelBtn = document.getElementById('cancelBtn');
                    const checkinBtn = document.getElementById('checkinBtn');
                    
                    if (myPoint) {
                        const timeAgo = getTimeAgo(myPoint.checkinTime);
                        statusEl.innerHTML = `üìç ${myPoint.placeName} <span style="opacity:0.7">(${timeAgo})</span>`;
                        statusEl.className = 'status active';
                        cancelBtn.style.display = 'block';
                        checkinBtn.textContent = 'üìç ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà';
                    } else {
                        statusEl.textContent = '‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
                        statusEl.className = 'status inactive';
                        cancelBtn.style.display = 'none';
                        checkinBtn.textContent = 'üìç ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô';
                    }
                }
            } catch (err) {
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function renderMarkers(checkins) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            const bounds = new google.maps.LatLngBounds();

            checkins.forEach(c => {
                const pos = new google.maps.LatLng(c.lat, c.lng);
                const isMe = c.userId === userProfile.userId;
                const marker = new ProfileMarkerClass(pos, c, isMe);
                marker.setMap(map);
                markers.push(marker);
                bounds.extend(pos);
            });

            if (checkins.length > 0) {
                map.fitBounds(bounds);
                if (checkins.length === 1) map.setZoom(15);
            }
        }

        function openCheckinModal() {
            document.getElementById('checkinModal').classList.add('active');
            document.getElementById('gpsStatus').className = 'gps-status';
            document.getElementById('gpsText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...';
            
            navigator.geolocation.getCurrentPosition(
                p => {
                    currentLat = p.coords.latitude;
                    currentLng = p.coords.longitude;
                    document.getElementById('gpsStatus').className = 'gps-status success';
                    document.getElementById('gpsText').textContent = '‚úÖ ‡∏•‡πá‡∏≠‡∏Ñ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                },
                e => {
                    document.getElementById('gpsStatus').className = 'gps-status error';
                    document.getElementById('gpsText').textContent = '‚ùå ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Location';
                },
                { enableHighAccuracy: true }
            );
        }

        function closeCheckinModal() { 
            document.getElementById('checkinModal').classList.remove('active'); 
        }

        async function submitCheckin(e) {
            e.preventDefault();
            if (!currentLat) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ GPS ‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
            
            showLoading(true);
            try {
                const res = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'addCheckin',
                        userId: userProfile.userId,
                        nickname: userProfile.displayName,
                        pictureUrl: userProfile.pictureUrl,
                        lat: currentLat,
                        lng: currentLng,
                        placeName: document.getElementById('placeName').value,
                        caption: document.getElementById('caption').value,
                        expireHours: 24  // Fixed 24 hours
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    closeCheckinModal();
                    document.getElementById('placeName').value = '';
                    document.getElementById('caption').value = '';
                    await refreshData();
                }
            } catch (err) { 
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); 
            }
            showLoading(false);
        }

        async function cancelCheckin() {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            showLoading(true);
            try {
                await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'deleteCheckin', userId: userProfile.userId })
                });
                await refreshData();
                showToast('‚úÖ ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
            } catch (err) { 
                showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); 
            }
            showLoading(false);
        }

        function showLoading(s) { 
            document.getElementById('loadingOverlay').classList.toggle('active', s); 
        }
        
        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>

    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTS-AxrXpfxj7-14GjX0Asi3QhdYxg7ao&loading=async&callback=initMap"></script>
</body>
</html>
