<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìç Map ‡∏£‡∏ß‡∏°‡∏û‡∏• ‡∏£‡∏∏‡πà‡∏ô 74</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #1a1a2e; 
            color: #fff; 
            height: 100vh; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header { 
            background: linear-gradient(135deg, #8B0000, #DC143C); 
            padding: 12px 16px; 
            z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .header h1 { font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .header .count { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 13px; }

        .profile-bar { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 12px; }
        .profile-bar img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        .profile-bar .info { flex: 1; }
        .profile-bar .name { font-size: 14px; font-weight: 600; }
        .profile-bar .status { font-size: 11px; opacity: 0.9; }
        .profile-bar .status.active { color: #4ade80; }
        .profile-bar .status.inactive { color: #fbbf24; }
        .profile-bar .cancel-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }

        #map { 
            flex-grow: 1;
            width: 100%;
            background: #0d0d1a;
        }

        .bottom-actions { 
            background: #1a1a2e; 
            padding: 12px 16px; 
            display: flex; 
            gap: 10px; 
            z-index: 1000; 
            border-top: 1px solid #333;
            padding-bottom: env(safe-area-inset-bottom, 12px);
        }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, #DC143C, #8B0000); color: #fff; }
        .btn-secondary { background: #333; color: #fff; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { background: #333; border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #aaa; }
        .form-group input, .form-group textarea { width: 100%; padding: 14px; border: 1px solid #333; border-radius: 12px; background: #0d0d1a; color: #fff; font-size: 16px; }
        .form-group textarea { resize: none; height: 80px; }
        .form-group small { color: #888; font-size: 12px; margin-top: 4px; display: block; }

        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #DC143C; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; z-index: 2500; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .gps-status { background: #0d0d1a; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 16px; border: 1px solid #333; }
        .gps-status.success { border-color: #22c55e; }
        .gps-status.error { border-color: #ef4444; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <h1>üìç Map ‡∏£‡∏ß‡∏°‡∏û‡∏• ‡∏£‡∏∏‡πà‡∏ô 74</h1>
            <span class="count" id="activeCount">0 ‡∏Ñ‡∏ô</span>
        </div>
        <div class="profile-bar" id="profileBar" style="display:none;">
            <img id="profilePic" src="" alt="Profile">
            <div class="info">
                <div class="name" id="profileName">-</div>
                <div class="status" id="profileStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </div>
            <button class="cancel-btn" id="cancelBtn" style="display:none;" onclick="cancelCheckin()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </header>

    <div id="map"></div>

    <div class="bottom-actions">
        <button class="btn btn-secondary" onclick="refreshData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn btn-primary" id="checkinBtn" onclick="openCheckinModal()">üìç ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•</button>
    </div>

    <div class="modal-overlay" id="checkinModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üìç ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•</h2>
                <button class="modal-close" onclick="closeCheckinModal()">‚úï</button>
            </div>
            <div class="gps-status" id="gpsStatus">
                <span>üì°</span>
                <span id="gpsText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...</span>
            </div>
            <form onsubmit="submitCheckin(event)">
                <div class="form-group">
                    <label>üìç ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà *</label>
                    <input type="text" id="placeName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡πâ‡∏≤‡πÄ‡∏à‡πä‡∏Å‡πÄ‡∏°‡πâ‡∏á, ‡∏´‡πâ‡∏≤‡∏á Central" required>
                </div>
                <div class="form-group">
                    <label>üí¨ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <textarea id="caption" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"></textarea>
                    <small>‚è∞ ‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</small>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">‚úÖ ‡∏ï‡∏Å‡∏•‡∏á‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•</button>
            </form>
        </div>
    </div>

    <div class="loading-overlay active" id="loadingOverlay">
        <div class="spinner"></div>
        <span style="margin-top:10px" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</span>
    </div>
    <div class="toast" id="toast"></div>

    <script>
        const CONFIG = {
            LIFF_ID: '2008817438-v258p2h9',
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwg28bbMZqSHly3IxvDWxh6VHXKWv5YlYUiOyVcceoNTDsECmmu3LkMZbObqy6yhJeF/exec'
        };

        let map, markers = [], userProfile = null, currentLat = null, currentLng = null;
        let ProfileMarkerClass = null;

        function getTimeAgo(timestamp) {
            if (!timestamp) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            if (diffMins < 60) return diffMins + ' ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            if (diffHours < 24) return diffHours + ' ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
            return Math.floor(diffHours / 24) + ' ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß';
        }

        // 1. Initialize Map
        function initMap() {
            console.log('--- Google Maps Initialize ---');
            const mapContainer = document.getElementById('map');
            
            map = new google.maps.Map(mapContainer, {
                center: { lat: 13.7563, lng: 100.5018 },
                zoom: 6,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                styles: [{ featureType: "poi.business", stylers: [{ visibility: "off" }] }]
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Custom Marker
            ProfileMarkerClass = class extends google.maps.OverlayView {
                constructor(pos, data, isMe) {
                    super();
                    this.pos = pos;
                    this.data = data;
                    this.isMe = isMe;
                }
                onAdd() {
                    console.log(`[Marker] onAdd: ${this.data.nickname}`);
                    const div = document.createElement('div');
                    div.style.position = 'absolute';
                    div.style.cursor = 'pointer';
                    div.style.zIndex = this.isMe ? "1000" : "500";
                    
                    const color = this.isMe ? '#22c55e' : '#DC143C';
                    const timeAgo = getTimeAgo(this.data.checkinTime);
                    const caption = this.data.caption || '';
                    
                    div.innerHTML = `
                        <div style="background:#fff; border:3px solid ${color}; border-radius:12px; padding:6px; min-width:85px; box-shadow:0 4px 12px rgba(0,0,0,0.5); position:relative;">
                            <img src="${this.data.pictureUrl}" style="width:50px; height:50px; border-radius:8px; display:block; margin:0 auto; object-fit:cover;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(this.data.nickname)}&background=DC143C&color=fff'">
                            <div style="font-size:11px; color:#333; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center; margin-top:4px;">${this.isMe ? '‚≠ê ' : ''}${this.data.nickname}</div>
                            <div style="font-size:9px; color:${color}; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center;">üìç ${this.data.placeName}</div>
                            ${caption ? `<div style="font-size:9px; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center; font-style:italic;">"${caption}"</div>` : ''}
                            <div style="font-size:8px; color:#999; text-align:center; margin-top:2px;">üïê ${timeAgo}</div>
                            <div style="position:absolute; bottom:-10px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-top:10px solid ${color};"></div>
                        </div>
                    `;
                    div.onclick = () => showInfo(this.data, this.pos);
                    this.div = div;
                    
                    // ‡πÉ‡∏ä‡πâ overlayLayer ‡πÅ‡∏ó‡∏ô overlayMouseTarget ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
                    const panes = this.getPanes();
                    panes.overlayMouseTarget.appendChild(div);
                }
                draw() {
                    const overlayProjection = this.getProjection();
                    if (!overlayProjection) return;
                    
                    const point = overlayProjection.fromLatLngToDivPixel(this.pos);
                    if (this.div && point) {
                        this.div.style.left = (point.x - 45) + 'px';
                        this.div.style.top = (point.y - 120) + 'px';
                    }
                }
                onRemove() {
                    if (this.div) {
                        this.div.parentNode.removeChild(this.div);
                        this.div = null;
                    }
                }
            };

            initLIFF();
        }

        function showInfo(data, pos) {
            const timeAgo = getTimeAgo(data.checkinTime);
            const content = `
                <div style="color:#333; padding:8px; min-width:200px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <img src="${data.pictureUrl}" style="width:45px; height:45px; border-radius:50%; object-fit:cover;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(data.nickname)}&background=DC143C&color=fff'">
                        <div>
                            <strong style="font-size:16px;">${data.nickname}</strong><br>
                            <span style="font-size:12px; color:#999;">üïê ${timeAgo}</span>
                        </div>
                    </div>
                    <div style="color:#DC143C; font-weight:bold; font-size:14px; margin-bottom:4px;">üìç ${data.placeName}</div>
                    ${data.caption ? `<div style="color:#666; font-style:italic; margin-bottom:8px;">"${data.caption}"</div>` : ''}
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}" target="_blank" style="display:block; background:#DC143C; color:#fff; text-align:center; padding:10px; border-radius:8px; text-decoration:none; font-weight:bold;">üöó ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏≤</a>
                </div>
            `;
            const iw = new google.maps.InfoWindow({ content, position: pos });
            iw.open(map);
        }

        // 2. LIFF Logic
        async function initLIFF() {
            try {
                console.log('LIFF: Initializing...');
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                console.log('LIFF: Profile loaded', userProfile.displayName);
                
                document.getElementById('profileBar').style.display = 'flex';
                document.getElementById('profilePic').src = userProfile.pictureUrl;
                document.getElementById('profileName').textContent = userProfile.displayName;
                
                await refreshData();
            } catch (err) {
                console.error('LIFF Error:', err);
                showToast('LIFF Error: ' + err.message);
            }
            showLoading(false);
        }

        async function refreshData() {
            console.log('Data: Fetching from GAS...');
            try {
                const res = await fetch(CONFIG.GAS_URL + '?action=getCheckins');
                const data = await res.json();
                
                console.log('Data: Received Result', data.success);
                if (data.success) {
                    console.log(`Data: Found ${data.checkins.length} checkins`);
                    console.table(data.checkins); // ‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ä‡∏±‡∏î‡πÜ ‡πÉ‡∏ô Console
                    
                    if (data.checkins.length === 0) {
                        showToast('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏');
                    } else {
                        showToast(`üìç ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ${data.checkins.length} ‡∏Ñ‡∏ô`);
                    }

                    renderMarkers(data.checkins);
                    document.getElementById('activeCount').textContent = data.checkins.length + ' ‡∏Ñ‡∏ô';
                    
                    if (userProfile) {
                        const myPoint = data.checkins.find(c => c.userId === userProfile.userId);
                        const statusEl = document.getElementById('profileStatus');
                        const cancelBtn = document.getElementById('cancelBtn');
                        const checkinBtn = document.getElementById('checkinBtn');
                        
                        if (myPoint) {
                            statusEl.textContent = 'üìç ' + myPoint.placeName;
                            statusEl.className = 'status active';
                            cancelBtn.style.display = 'block';
                            checkinBtn.textContent = 'üìç ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà';
                        } else {
                            statusEl.textContent = '‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•';
                            statusEl.className = 'status inactive';
                            cancelBtn.style.display = 'none';
                            checkinBtn.textContent = 'üìç ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•';
                        }
                    }
                } else {
                    console.error('GAS Error:', data.error);
                    showToast('Error: ' + data.error);
                }
            } catch (err) {
                console.error('Fetch error:', err);
                showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            }
        }

        function renderMarkers(checkins) {
            console.log(`Render: Start rendering ${checkins.length} markers`);
            
            // ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏Å‡πà‡∏≤
            markers.forEach(m => m.setMap(null));
            markers = [];
            
            if (!ProfileMarkerClass) {
                console.error('Render Error: ProfileMarkerClass is not ready');
                return;
            }

            const bounds = new google.maps.LatLngBounds();
            let validCount = 0;

            checkins.forEach((c) => {
                const lat = parseFloat(c.lat);
                const lng = parseFloat(c.lng);
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.warn(`Render Skip: Invalid coords for ${c.nickname}`);
                    return;
                }

                const pos = new google.maps.LatLng(lat, lng);
                const isMe = userProfile && c.userId === userProfile.userId;
                
                const marker = new ProfileMarkerClass(pos, c, isMe);
                marker.setMap(map);
                markers.push(marker);
                bounds.extend(pos);
                validCount++;
            });

            console.log(`Render: Success, ${validCount} markers set to map`);

            if (validCount > 0) {
                map.fitBounds(bounds);
                // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                if (validCount === 1) {
                    const listener = google.maps.event.addListener(map, 'idle', () => {
                        if (map.getZoom() > 15) map.setZoom(15);
                        google.maps.event.removeListener(listener);
                    });
                }
            }
        }

        // 3. UI Interactions
        function openCheckinModal() {
            document.getElementById('checkinModal').classList.add('active');
            document.getElementById('gpsStatus').className = 'gps-status';
            document.getElementById('gpsText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...';
            
            navigator.geolocation.getCurrentPosition(
                p => {
                    currentLat = p.coords.latitude;
                    currentLng = p.coords.longitude;
                    document.getElementById('gpsStatus').className = 'gps-status success';
                    document.getElementById('gpsText').textContent = '‚úÖ ‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
                },
                e => {
                    console.error('GPS Error:', e);
                    document.getElementById('gpsStatus').className = 'gps-status error';
                    document.getElementById('gpsText').textContent = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function closeCheckinModal() { 
            document.getElementById('checkinModal').classList.remove('active'); 
        }

        async function submitCheckin(e) {
            e.preventDefault();
            if (!currentLat || !currentLng) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ GPS ‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
            
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            try {
                const res = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'addCheckin',
                        userId: userProfile.userId,
                        nickname: userProfile.displayName,
                        pictureUrl: userProfile.pictureUrl,
                        lat: currentLat,
                        lng: currentLng,
                        placeName: document.getElementById('placeName').value,
                        caption: document.getElementById('caption').value,
                        expireHours: 24
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    closeCheckinModal();
                    document.getElementById('placeName').value = '';
                    document.getElementById('caption').value = '';
                    await refreshData();
                    map.panTo({ lat: currentLat, lng: currentLng });
                } else {
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error);
                }
            } catch (err) { 
                console.error('Submit error:', err);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); 
            }
            showLoading(false);
        }

        async function cancelCheckin() {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î...");
            try {
                const res = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'deleteCheckin', userId: userProfile.userId })
                });
                const data = await res.json();
                if (data.success) {
                    await refreshData();
                    showToast('‚úÖ ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                }
            } catch (err) { 
                showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); 
            }
            showLoading(false);
        }

        function showLoading(s, text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") { 
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.toggle('active', s); 
        }
        
        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>

    <!-- Google Maps API -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTS-AxrXpfxj7-14GjX0Asi3QhdYxg7ao&loading=async&callback=initMap"></script>
</body>
</html>
