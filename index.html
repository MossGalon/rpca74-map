<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìç Map ‡∏£‡∏ß‡∏°‡∏û‡∏• ‡∏£‡∏∏‡πà‡∏ô 74</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #1a1a2e; 
            color: #fff; 
            height: 100vh; 
            overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏±‡πà‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏π‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
            display: flex;
            flex-direction: column;
        }

        /* Header Layout */
        .header { 
            background: linear-gradient(135deg, #8B0000, #DC143C); 
            padding: 12px 16px; 
            z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .header h1 { font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .header .count { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 13px; }

        .profile-bar { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 12px; }
        .profile-bar img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
        .profile-bar .info { flex: 1; }
        .profile-bar .name { font-size: 14px; font-weight: 600; }
        .profile-bar .status { font-size: 11px; opacity: 0.9; }
        .profile-bar .status.active { color: #4ade80; }
        .profile-bar .status.inactive { color: #fbbf24; }
        .profile-bar .cancel-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }

        /* Map Container - ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Flex grow */
        #map { 
            flex-grow: 1;
            width: 100%;
            background: #0d0d1a; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î map */
        }

        .bottom-actions { 
            background: #1a1a2e; 
            padding: 12px 16px; 
            display: flex; 
            gap: 10px; 
            z-index: 1000; 
            border-top: 1px solid #333;
            padding-bottom: env(safe-area-inset-bottom, 12px); /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iPhone X+ */
        }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, #DC143C, #8B0000); color: #fff; }
        .btn-secondary { background: #333; color: #fff; }
        .btn-danger { background: #ef4444; color: #fff; }

        /* Modal & UI Elements */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { background: #333; border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #aaa; }
        .form-group input, .form-group textarea { width: 100%; padding: 14px; border: 1px solid #333; border-radius: 12px; background: #0d0d1a; color: #fff; font-size: 16px; }
        
        .expire-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .expire-option { padding: 12px 8px; background: #0d0d1a; border: 2px solid #333; border-radius: 12px; text-align: center; cursor: pointer; }
        .expire-option.selected { border-color: #DC143C; background: rgba(220, 20, 60, 0.1); }

        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #DC143C; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; z-index: 2500; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .gps-status { background: #0d0d1a; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 16px; border: 1px solid #333; }
        .gps-status.success { border-color: #22c55e; }
        .gps-status.error { border-color: #ef4444; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <h1>üìç Map ‡∏£‡∏ß‡∏°‡∏û‡∏• ‡∏£‡∏∏‡πà‡∏ô 74</h1>
            <span class="count" id="activeCount">0 ‡∏Ñ‡∏ô</span>
        </div>
        <div class="profile-bar" id="profileBar" style="display:none;">
            <img id="profilePic" src="" alt="Profile">
            <div class="info">
                <div class="name" id="profileName">-</div>
                <div class="status" id="profileStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <button class="cancel-btn" id="cancelBtn" style="display:none;" onclick="cancelCheckin()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
        </div>
    </header>

    <div id="map"></div>

    <div class="bottom-actions">
        <button class="btn btn-secondary" onclick="refreshMap()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn btn-primary" id="checkinBtn" onclick="openCheckinModal()">üìç ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="checkinModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üìç ‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <button class="modal-close" onclick="closeCheckinModal()">‚úï</button>
            </div>
            <div class="gps-status" id="gpsStatus">
                <span id="gpsIcon">üì°</span>
                <span id="gpsText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...</span>
            </div>
            <form onsubmit="submitCheckin(event)">
                <div class="form-group">
                    <label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡∏£‡πâ‡∏≤‡∏ô</label>
                    <input type="text" id="placeName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏à‡πä‡∏Å‡πÄ‡∏°‡πâ‡∏á, ‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required>
                </div>
                <div class="form-group">
                    <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <textarea id="caption" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö"></textarea>
                </div>
                <div class="form-group">
                    <label>‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á?</label>
                    <div class="expire-options">
                        <div class="expire-option" data-hours="3" onclick="selectExpire(this)">3‡∏ä‡∏°.</div>
                        <div class="expire-option selected" data-hours="6" onclick="selectExpire(this)">6‡∏ä‡∏°.</div>
                        <div class="expire-option" data-hours="12" onclick="selectExpire(this)">12‡∏ä‡∏°.</div>
                        <div class="expire-option" data-hours="24" onclick="selectExpire(this)">1‡∏ß‡∏±‡∏ô</div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">‚úÖ ‡∏ï‡∏Å‡∏•‡∏á ‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡πÄ‡∏Ñ‡∏ä‡∏±‡πà‡∏ô</button>
            </form>
        </div>
    </div>

    <div class="loading-overlay active" id="loadingOverlay"><div class="spinner"></div><span style="margin-top:10px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</span></div>
    <div class="toast" id="toast"></div>

    <script>
        const CONFIG = {
            LIFF_ID: '2008817438-v258p2h9',
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwg4gQ66uNni4cSauLtN9S0uuBVq-Co0ydTcrVB2mU7aJHy4q9EalBtcpX4V9iPLkFG/exec'
        };

        let map, markers = [], userProfile = null, currentLat = null, currentLng = null, selectedExpireHours = 6;
        let ProfileMarkerClass = null;

        // 1. Google Maps Initialize
        function initMap() {
            console.log('Google Maps Callback Triggered');
            const mapContainer = document.getElementById('map');
            
            map = new google.maps.Map(mapContainer, {
                center: { lat: 13.7563, lng: 100.5018 },
                zoom: 6,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                styles: [{ featureType: "poi.business", stylers: [{ visibility: "off" }] }]
            });

            // Define Custom Overlay
            ProfileMarkerClass = class extends google.maps.OverlayView {
                constructor(pos, data, isMe) {
                    super();
                    this.pos = pos;
                    this.data = data;
                    this.isMe = isMe;
                }
                onAdd() {
                    const div = document.createElement('div');
                    div.style.position = 'absolute';
                    div.style.cursor = 'pointer';
                    const color = this.isMe ? '#22c55e' : '#DC143C';
                    div.innerHTML = `
                        <div style="background:#fff; border:3px solid ${color}; border-radius:12px; padding:5px; width:60px; box-shadow:0 2px 5px rgba(0,0,0,0.5); position:relative;">
                            <img src="${this.data.pictureUrl}" style="width:100%; border-radius:8px; display:block;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(this.data.nickname)}'">
                            <div style="font-size:10px; color:#333; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center; margin-top:2px;">${this.data.nickname}</div>
                            <div style="position:absolute; bottom:-10px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-top:10px solid ${color};"></div>
                        </div>
                    `;
                    div.onclick = () => showInfo(this.data, this.pos);
                    this.div = div;
                    this.getPanes().overlayMouseTarget.appendChild(div);
                }
                draw() {
                    const overlayProjection = this.getProjection();
                    const point = overlayProjection.fromLatLngToDivPixel(this.pos);
                    if (this.div) {
                        this.div.style.left = (point.x - 30) + 'px';
                        this.div.style.top = (point.y - 70) + 'px';
                    }
                }
                onRemove() { if (this.div) this.div.parentNode.removeChild(this.div); }
            };

            initLIFF();
        }

        function showInfo(data, pos) {
            const content = `
                <div style="color:#333; padding:5px;">
                    <strong style="font-size:16px;">${data.nickname}</strong><br>
                    <span style="color:#DC143C; font-weight:bold;">üìç ${data.placeName}</span><br>
                    ${data.caption ? `<small>"${data.caption}"</small><br>` : ''}
                    <hr style="margin:5px 0">
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}" target="_blank" style="display:block; background:#DC143C; color:#fff; text-align:center; padding:8px; border-radius:5px; text-decoration:none; margin-top:5px;">üöó ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏≤</a>
                </div>
            `;
            const iw = new google.maps.InfoWindow({ content, position: pos });
            iw.open(map);
        }

        // 2. LIFF & Data
        async function initLIFF() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                document.getElementById('profileBar').style.display = 'flex';
                document.getElementById('profilePic').src = userProfile.pictureUrl;
                document.getElementById('profileName').textContent = userProfile.displayName;
                
                await refreshMap();
            } catch (err) {
                console.error('LIFF Error', err);
                showToast('LIFF Error: ' + err.message);
            }
            showLoading(false);
        }

        async function refreshMap() {
            try {
                const res = await fetch(CONFIG.GAS_URL + '?action=getCheckins');
                const data = await res.json();
                if (data.success) {
                    renderMarkers(data.checkins);
                    document.getElementById('activeCount').textContent = data.checkins.length + ' ‡∏Ñ‡∏ô';
                    
                    const myPoint = data.checkins.find(c => c.userId === userProfile.userId);
                    const statusEl = document.getElementById('profileStatus');
                    const cancelBtn = document.getElementById('cancelBtn');
                    
                    if (myPoint) {
                        statusEl.textContent = '‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà: ' + myPoint.placeName;
                        statusEl.className = 'status active';
                        cancelBtn.style.display = 'block';
                    } else {
                        statusEl.textContent = '‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
                        statusEl.className = 'status inactive';
                        cancelBtn.style.display = 'none';
                    }
                }
            } catch (err) {
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function renderMarkers(checkins) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            const bounds = new google.maps.LatLngBounds();

            checkins.forEach(c => {
                const pos = new google.maps.LatLng(c.lat, c.lng);
                const isMe = c.userId === userProfile.userId;
                const marker = new ProfileMarkerClass(pos, c, isMe);
                marker.setMap(map);
                markers.push(marker);
                bounds.extend(pos);
            });

            if (checkins.length > 0) {
                map.fitBounds(bounds);
                if (checkins.length === 1) map.setZoom(15);
            }
        }

        // 3. Logic Functions
        function openCheckinModal() {
            document.getElementById('checkinModal').classList.add('active');
            navigator.geolocation.getCurrentPosition(
                p => {
                    currentLat = p.coords.latitude;
                    currentLng = p.coords.longitude;
                    document.getElementById('gpsStatus').className = 'gps-status success';
                    document.getElementById('gpsText').textContent = '‚úÖ ‡∏•‡πá‡∏≠‡∏Ñ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                },
                e => {
                    document.getElementById('gpsStatus').className = 'gps-status error';
                    document.getElementById('gpsText').textContent = '‚ùå ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Location';
                },
                { enableHighAccuracy: true }
            );
        }

        function closeCheckinModal() { document.getElementById('checkinModal').classList.remove('active'); }

        function selectExpire(el) {
            document.querySelectorAll('.expire-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedExpireHours = parseInt(el.dataset.hours);
        }

        async function submitCheckin(e) {
            e.preventDefault();
            if (!currentLat) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ GPS ‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
            
            showLoading(true);
            try {
                const res = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'addCheckin',
                        userId: userProfile.userId,
                        nickname: userProfile.displayName,
                        pictureUrl: userProfile.pictureUrl,
                        lat: currentLat,
                        lng: currentLng,
                        placeName: document.getElementById('placeName').value,
                        caption: document.getElementById('caption').value,
                        expireHours: selectedExpireHours
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    closeCheckinModal();
                    await refreshMap();
                }
            } catch (err) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); }
            showLoading(false);
        }

        async function cancelCheckin() {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            showLoading(true);
            try {
                await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'deleteCheckin', userId: userProfile.userId })
                });
                await refreshMap();
                showToast('‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
            } catch (err) { showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            showLoading(false);
        }

        function showLoading(s) { document.getElementById('loadingOverlay').classList.toggle('active', s); }
        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>

    <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° loading=async ‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢ callback ‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTS-AxrXpfxj7-14GjX0Asi3QhdYxg7ao&loading=async&callback=initMap"></script>
</body>
</html>
